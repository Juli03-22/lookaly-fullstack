# =============================================================================
# nginx.conf — Reverse proxy con TLS para Lookaly
#
# 4.1 – Uso de HTTPS siempre
# ──────────────────────────
# • Terminación TLS en nginx (certificates en /etc/nginx/certs/).
# • Redireccion HTTP → HTTPS: todo el trafico en puerto 80 es
#   forzado a HTTPS 443 mediante un 301 permanente.
# • Protocolo mínimo: TLSv1.2 (deshabilita SSL3, TLS 1.0, TLS 1.1).
# • Cifrados: solo suites con Perfect Forward Secrecy (ECDHE).
#   Se excluyen explícitamente: RC4, MD5, aNULL, eNULL, EXPORT,
#   DES, 3DES, DSS, PSK (inseguros o débiles).
# • HSTS: max-age=63072000 (~2 años) + includeSubDomains + preload.
# =============================================================================

# ── Logging ───────────────────────────────────────────────────────────────────
error_log  /var/log/nginx/error.log warn;
access_log /var/log/nginx/access.log;

# ── 1. Redireccion HTTP → HTTPS (4.1) ────────────────────────────────────────
server {
    listen 80;
    server_name _;   # responde a cualquier hostname

    # Redirige TODA peticion HTTP a HTTPS con 301 permanente
    return 301 https://$host$request_uri;
}

# ── 2. Server HTTPS principal (4.1) ──────────────────────────────────────────
server {
    listen 443 ssl;
    server_name localhost;

    # ── Certificados TLS ─────────────────────────────────────────────────────
    # • Dev: certificado autofirmado generado con gen-certs.sh
    # • Prod: sustituir por certificados de Let's Encrypt (certbot)
    ssl_certificate     /etc/nginx/certs/server.crt;
    ssl_certificate_key /etc/nginx/certs/server.key;

    # ── Protocolos seguros (desactiva SSLv3, TLS 1.0 y TLS 1.1) ─────────────
    ssl_protocols TLSv1.2 TLSv1.3;

    # ── Cifrados — solo suites con Perfect Forward Secrecy ───────────────────
    # Preferencia del servidor sobre la del cliente (ssl_prefer_server_ciphers on)
    # Excluidos: RC4, MD5, aNULL, EXPORT, DES, 3DES, DSS, PSK
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!RC4:!MD5:!DSS:!PSK';
    ssl_prefer_server_ciphers on;

    # ── Session tickets / cache ───────────────────────────────────────────────
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;  # desactivar session tickets (evita ruptura de PFS)

    # ── HSTS (4.1) ────────────────────────────────────────────────────────────
    # Indica al navegador que solo use HTTPS durante 2 años
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

    # ── Cabeceras de seguridad adicionales ────────────────────────────────────
    add_header X-Frame-Options            "DENY"            always;
    add_header X-Content-Type-Options     "nosniff"         always;
    add_header Referrer-Policy            "strict-origin-when-cross-origin" always;
    add_header X-XSS-Protection           "1; mode=block"   always;

    # Ocultar version de nginx
    server_tokens off;

    # ── Proxy al backend FastAPI ──────────────────────────────────────────────
    location /api/ {
        proxy_pass         http://backend:8000;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_read_timeout 30s;
        proxy_send_timeout 30s;
    }

    # ── Proxy al frontend Vite ────────────────────────────────────────────────
    location / {
        proxy_pass         http://frontend:5173;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-Proto $scheme;

        # WebSocket para HMR de Vite
        proxy_http_version 1.1;
        proxy_set_header   Upgrade    $http_upgrade;
        proxy_set_header   Connection "upgrade";
    }
}
